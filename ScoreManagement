using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using System.Runtime.Serialization.Formatters.Binary;
using System.IO;

[System.Serializable]
public class TimeData
{
    public float TimePassed;
}
public class ScoreManagement : MonoBehaviour
{
    GameObject Player;
    [Header("Time")]
    public TimeData Time1;

    [Header("Scores")]
    public float TotalScore;

    [Header("Strings")]
    [SerializeField] GameObject StringObj;
    [SerializeField] GameObject TotalScoresObj;
    [SerializeField] GameObject FpsCounter;

    [Header("Combo")]
    float Multipler;
    [SerializeField] float ComboTimeLeft;
    public bool[] Combo;
    float RageM;

    bool WriteDown = false;
    int WriteIndex;

    public HighScore Score;
    SettingsOpt Settings;
    void Start()
    {
        Player = GameObject.FindGameObjectWithTag("Player");
        LoadTime();
        if (File.Exists(Application.persistentDataPath + "/" + "Settings" + ".dat"))
        {
            BinaryFormatter BF = new BinaryFormatter();
            FileStream file = File.Open(Application.persistentDataPath + "/" + "Settings" + ".dat", FileMode.Open);
            Settings = BF.Deserialize(file) as SettingsOpt;
            file.Close();
            Debug.Log(Settings.VolumeValue);
            Debug.Log(Settings.FpsC);
            AudioListener.volume = Settings.VolumeValue;
            if (Settings.FpsC == true)
            {
                FpsCounter.SetActive(true);
            }
            else
            {
                FpsCounter.SetActive(false);
            }
        }
    }
    public void SaveTime()
    {
        BinaryFormatter BF = new BinaryFormatter();
        FileStream file = File.Create(Application.persistentDataPath + "/" + "TimeData" + ".dat");
        BF.Serialize(file, Time1);
        file.Close();
        
    }
    public void LoadTime()
    {
        if (File.Exists(Application.persistentDataPath + "/" + "TimeData" + ".dat"))
        {
            BinaryFormatter BF = new BinaryFormatter();
            FileStream file = File.Open(Application.persistentDataPath + "/" + "TimeData" + ".dat", FileMode.Open);
            Time1 = BF.Deserialize(file) as TimeData;
            file.Close();
        }
    }
    public void CalculateEndScore()
    {

        TotalScore = TotalScore / Time1.TimePassed;
        if (File.Exists(Application.persistentDataPath + "/" + "HighScores" + ".dat"))
        {
            BinaryFormatter BF = new BinaryFormatter();
            FileStream file = File.Open(Application.persistentDataPath + "/" + "HighScores" + ".dat", FileMode.Open);
            Score = BF.Deserialize(file) as HighScore;
            file.Close();
            for(int i = 0; i < Score.HighScores.Length; i++)
            {
                if(TotalScore > Score.HighScores[i])
                {
                    WriteDown = true;
                    WriteIndex = i;
                    Score.HighScores[i] = TotalScore;
                    break;
                }
            }
            if (WriteDown)
            {
                for(int i = Score.HighScores.Length - 1; i < WriteIndex; i--)
                {
                    Score.HighScores[i] = Score.HighScores[i - 1];
                }
            }

            FileStream file1 = File.Create(Application.persistentDataPath + "/" + "HighScores" + ".dat");
            BF.Serialize(file1, Score);
            file1.Close();
        }
        else
        {
            BinaryFormatter BF = new BinaryFormatter();
            FileStream file = File.Create(Application.persistentDataPath + "/" + "HighScores" + ".dat");
            Score.HighScores[0] = TotalScore;
            for(int i = 1; i< Score.HighScores.Length; i++)
            {
                Score.HighScores[i] = 0;
            }
            BF.Serialize(file, Score);
            file.Close();
        }
    }
     public void ActiveCombo()
    {
        StopCoroutine(DecreaseCombo());
        for (int i = 0; i < Combo.Length; i++)
        {
            if (!Combo[i])
            {
                Multipler = i;
                Combo[i] = true;
                StartCoroutine(DecreaseCombo());
                break;
            }
        }
    }
    IEnumerator DecreaseCombo()
    {
        yield return new WaitForSeconds(ComboTimeLeft);
        for (int i = Combo.Length - 1 ; i > 0; i--)
        {
            if (Combo[i])
            {
                Multipler = i - 1;
                if(i < 1)
                {
                    Multipler = 1;
                }
                Combo[i] = false;
                break;
            }
        }
    }
    IEnumerator ChangeStringValue()
    {
        StringObj.GetComponent<UIAlpha>().FadeIn();
        yield return new WaitForSeconds(1.6f);
        StringObj.GetComponent<UIAlpha>().FadeOut();
    }
    public void AddScores(float S)
    {
        if(Multipler <= 0)
        {
            Multipler = 1;
        }
        S = S * Multipler;
        RageM = Player.GetComponent<PlayerRage>().Multipler;
        S = S * RageM;
        StringObj.GetComponent<Text>().text = "Added : " +  S.ToString();
        TotalScore += S;
        TotalScoresObj.GetComponent<Text>().text = "Total Scores : " + TotalScore.ToString();
        StartCoroutine(ChangeStringValue());
        
    }

    void Update()
    {
        Time1.TimePassed += Time.deltaTime;
        if (Input.GetMouseButtonDown(0))
        {
            
            CalculateEndScore();
        }
    }
}
